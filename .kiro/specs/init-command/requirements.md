# 要件定義書

## はじめに

`gh pm init` コマンドは、GitHub Projects (v2) と連携した プロジェクト管理を行うための設定ファイル（.gh-pm.yml）を初期化するコマンドです。このコマンドにより、プロジェクトの選択、リポジトリの設定、カスタムフィールドのマッピングを対話的または非対話的に設定し、プロジェクト管理の基盤を構築します。

## 要件

### 要件1: 設定ファイルの初期化

**ユーザーストーリー:** プロジェクト管理者として、gh-pm の設定ファイルを初期化したい。これにより、プロジェクト管理の基盤を迅速に構築できる。

#### 受け入れ基準

1. WHEN ユーザーが `gh pm init` コマンドを実行する THEN システムは .gh-pm.yml ファイルを現在のディレクトリに作成する
2. IF .gh-pm.yml ファイルが既に存在する THEN システムは上書き確認プロンプトを表示する
3. WHEN ユーザーが上書き確認で "y" を入力する THEN システムは既存ファイルを上書きする
4. WHEN ユーザーが上書き確認で "n" または他の入力をする THEN システムは初期化をキャンセルする
5. WHERE 設定ファイルが正常に作成された場合 THE システムは保存先パスと次のステップを表示する

### 要件2: プロジェクトの自動検出と選択

**ユーザーストーリー:** 開発者として、現在のリポジトリに関連するプロジェクトを自動検出して選択したい。これにより、設定の手間を最小限にできる。

#### 受け入れ基準

1. WHEN 初期化が実行される THEN システムは現在のGitリポジトリ情報を自動検出する
2. IF リポジトリが検出された AND --project フラグが指定されていない THEN システムはリポジトリのプロジェクト一覧を取得する
3. IF リポジトリのプロジェクトが0件 THEN システムは組織のプロジェクト一覧を取得する
4. WHEN プロジェクト一覧が取得できた THEN システムは詳細付きプロジェクト選択画面を表示する
5. WHERE プロジェクトが1件のみ存在する場合 THE システムは自動選択の確認プロンプトを表示する
6. WHERE プロジェクトが複数存在する場合 THE システムは番号付きリストで選択メニューを表示する
7. WHEN ユーザーが "N" を入力する THEN システムはプロジェクト番号の直接入力を受け付ける
8. IF ユーザーがプロジェクト名の部分文字列を入力する THEN システムは部分一致検索を実行し確認プロンプトを表示する

### 要件3: コマンドラインフラグによる設定

**ユーザーストーリー:** DevOps エンジニアとして、コマンドラインフラグを使って非対話的に設定を完了したい。これにより、自動化スクリプトに組み込める。

#### 受け入れ基準

1. WHEN --project フラグが指定される THEN システムはそのプロジェクト名を設定に使用する
2. WHEN --org フラグが指定される THEN システムはその組織名を設定に使用する
3. WHEN --repo フラグが指定される THEN システムは指定されたリポジトリを設定に追加する
4. WHERE --repo フラグで複数のリポジトリがカンマ区切りで指定された場合 THE システムはすべてのリポジトリを設定に追加する
5. WHEN --interactive=false が指定される THEN システムは対話的プロンプトをスキップする
6. WHEN --list フラグが指定される THEN システムは組織の全プロジェクトを表示する

### 要件4: 対話的モードでの設定入力

**ユーザーストーリー:** 新規ユーザーとして、対話的にガイドされながら設定を行いたい。これにより、必要な設定を漏れなく行える。

#### 受け入れ基準

1. WHEN 対話的モードが有効 AND プロジェクトが未設定 THEN システムはプロジェクト名入力プロンプトを表示する
2. IF リポジトリ名が検出されている THEN システムはそれをデフォルト値として提示する
3. WHEN 対話的モードが有効 AND 組織が未設定 THEN システムは組織名入力プロンプトを表示する
4. WHEN 対話的モードが有効 AND リポジトリが未設定 THEN システムはリポジトリ入力プロンプトを表示する
5. WHERE ユーザーが空の入力をした場合 THE システムはその設定項目をスキップする
6. IF デフォルト値が存在 AND ユーザーが空の入力をした THEN システムはデフォルト値を使用する

### 要件5: カスタムフィールドマッピングの設定

**ユーザーストーリー:** プロジェクト管理者として、GitHub Projectsのカスタムフィールドをgh-pmコマンドにマッピングしたい。これにより、プロジェクト固有のフィールドを活用できる。

#### 受け入れ基準

1. WHEN プロジェクトが選択された AND 対話的モード THEN システムはプロジェクトのカスタムフィールドを取得する
2. IF "Status" フィールドが存在 AND タイプが SINGLE_SELECT THEN システムはステータスマッピング設定プロンプトを表示する
3. WHEN ステータスマッピングが要求される THEN システムは自動マッピング候補を生成する
4. WHERE フィールド名に "todo", "backlog" が含まれる場合 THE システムは "todo" にマッピングする
5. WHERE フィールド名に "progress", "doing" が含まれる場合 THE システムは "in_progress" にマッピングする
6. WHERE フィールド名に "review" が含まれる場合 THE システムは "in_review" にマッピングする
7. WHERE フィールド名に "done", "complete" が含まれる場合 THE システムは "done" にマッピングする
8. WHEN ユーザーがカスタマイズを選択する THEN システムは各オプションの手動マッピングを受け付ける
9. IF "Priority" フィールドが存在 AND タイプが SINGLE_SELECT THEN システムは優先度マッピング設定プロンプトを表示する
10. WHEN 優先度マッピングが要求される THEN システムは自動マッピング候補を生成する
11. WHERE フィールド名に "low" が含まれる場合 THE システムは "low" にマッピングする
12. WHERE フィールド名に "medium", "normal" が含まれる場合 THE システムは "medium" にマッピングする
13. WHERE フィールド名に "high" が含まれる場合 THE システムは "high" にマッピングする
14. WHERE フィールド名に "critical", "urgent" が含まれる場合 THE システムは "critical" にマッピングする

### 要件6: プロジェクト詳細の自動取得

**ユーザーストーリー:** 開発者として、プロジェクト名を指定したらプロジェクト番号などの詳細を自動取得したい。これにより、手動での番号確認が不要になる。

#### 受け入れ基準

1. WHEN プロジェクト名と組織が設定されている AND プロジェクト番号が未設定 THEN システムはGitHub APIからプロジェクト詳細を取得する
2. IF プロジェクト詳細の取得に成功 THEN システムはプロジェクト番号を設定に保存する
3. IF プロジェクト詳細の取得に成功 THEN システムは利用可能なカスタムフィールド一覧を表示する
4. WHERE API接続エラーが発生した場合 THE システムは警告メッセージを表示し処理を継続する
5. WHERE プロジェクトが見つからない場合 THE システムは警告メッセージを表示し処理を継続する

### 要件7: 設定ファイルのデフォルト値

**ユーザーストーリー:** 新規ユーザーとして、適切なデフォルト値が設定された設定ファイルを生成したい。これにより、最小限の変更で使い始められる。

#### 受け入れ基準

1. WHEN 設定ファイルが生成される THEN システムはデフォルトの優先度を "medium" に設定する
2. WHEN 設定ファイルが生成される THEN システムはデフォルトのステータスを "Todo" に設定する
3. WHEN 設定ファイルが生成される THEN システムは "pm-tracked" ラベルをデフォルトラベルに含める
4. WHERE 現在のリポジトリが検出された場合 THE システムはそれをリポジトリリストの先頭に配置する
5. WHERE 出力フォーマットが未指定の場合 THE システムは "table" をデフォルトフォーマットとして設定する

### 要件8: プロジェクトメタデータの保存

**ユーザーストーリー:** パワーユーザーとして、初期化時にプロジェクトのメタデータ（各種ID）を設定ファイルに保存したい。これにより、後続のコマンドでこれらのIDを効率的に利用できる。

#### 受け入れ基準

1. WHEN プロジェクトが選択される THEN システムはプロジェクトのnode ID（GraphQL ID）を設定ファイルに保存する
2. WHEN プロジェクトのフィールドが取得される THEN システムはフィールドID（field ID）を設定ファイルに保存する
3. WHERE ステータスフィールドが設定される場合 THE システムは各ステータスオプションのID（option ID）をマッピングとして保存する
4. WHERE 優先度フィールドが設定される場合 THE システムは各優先度オプションのID（option ID）をマッピングとして保存する
5. WHERE メタデータが保存される場合 THE システムは .gh-pm.yml の metadata セクションに構造化して保存する
6. IF --skip-metadata フラグが指定される THEN システムはメタデータの取得と保存をスキップする
7. WHEN メタデータ取得でエラーが発生する THEN システムは警告を表示し、メタデータなしで設定ファイルを作成する
8. WHERE メタデータセクションが作成される場合 THE システムは以下の構造で保存する：
   - project.id: プロジェクトのnode ID
   - fields.status.id: ステータスフィールドのID
   - fields.status.options: 各ステータス値のオプションIDマッピング
   - fields.priority.id: 優先度フィールドのID  
   - fields.priority.options: 各優先度値のオプションIDマッピング